<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>
    Deform vector graphics
    </title>
    
    <script src="web-gui/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="web-gui/Blob.js" type="text/javascript"></script>
    <script src="web-gui/FileSaver.js" type="text/javascript"></script>
    
    <link rel="stylesheet" href="web-gui/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css"> -->
    <!-- <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap-theme.min.css"> -->
    <!-- <script src="https://netdna.bootstrapcdn.com/bootstrap/3.0.3/js/bootstrap.min.js"></script> -->
    <script src="web-gui/bootstrap.min.js"></script>

<style type="text/css">
body
{
    margin-top: 20px;
}
#svg-holder
{
    margin: 10px 45px;
    height: 400px;
    
    position: relative;
}
.absolute0
{
    position: absolute;
    left: 0;
    top: 0;
}
.empty
{
    outline: 9px dashed #ccc;
    font-size: 200%;
    font-weight: bold;
}
.empty:after
{
    content: "Drag an SVG file here."
}
.droppable
{
    outline: 9px dashed #0c0;
}
.not-droppable
{
    outline: 9px dashed #c00;
}

#filename
{
    font-family: monospace;
}
#save-button
{
    margin-left: 1em;
}
</style>

</head>
<body>
<div class="container">
<div id="file-info">
Editing: <span id="filename" class="text-muted">no file loaded</span>
<button id="save-button" class="btn btn-default" disabled>Save SVG</button>
</div>

<hr />
</div>

<div id="svg-holder" class="text-center empty">
<div id="svg-file" class="absolute0"></div>
<div id="svg-overlay" class="absolute0"></div>
</div>


<script type='text/javascript'>
///
/// Constants.
///
var kDebugging = false;

///
/// Global variables.
///

///
/// Global functions.
///
function isDroppable( evt )
{
    var files = evt.dataTransfer.files;
    if( files.length === 1 && files[0].type === 'image/svg+xml' )
    {
        return true;
    }
    return false;
}
function displayDroppable( evt )
{
    console.log("displayDroppable")
    
    evt.preventDefault();
    
    var droppable = isDroppable( evt );
    var add = ( droppable ? "droppable" : "not-droppable" );
    var remove = ( !droppable ? "droppable" : "not-droppable" );
    
    $("#svg-holder").removeClass( remove );
    $("#svg-holder").addClass( add );
}

function setupWebsocket()
{
    // TODO
}

function setupFileIO()
{
    // In order to use jQuery event handling with drag-and-drop events,
    // we have to tell jQuery to include it:
    jQuery.event.props.push( "dataTransfer" );
    
    $( window ).on( 'dragover', displayDroppable );
    // The dragenter and dragleave events are hard to use, because they fire when any child
    // element is entered. Instead, we use 'dragover' and let 'drop' take care of removing
    // the css classes.
    // $( window ).on( 'dragleave', function() { $('#svg-holder').removeClass( "droppable not-droppable" ); } );
    
    $( window ).on( 'drop', function( evt ) {
        evt.preventDefault();
        
        $('#svg-holder').removeClass( "droppable not-droppable" );
        
        if( !isDroppable( evt ) ) return;
        
        var file = evt.dataTransfer.files[0];
        var reader = new FileReader();
        
        reader.onloadend = function(evt) {
            if (evt.target.readyState == FileReader.DONE) {
                var svg_text = reader.result;
                
                $("#filename").text( file.name );
                $("#filename").removeClass( "text-muted" );
                
                loadSVG( svg_text );
                
                $("#save-button").prop( "disabled", false );
            }
            }
        
        reader.readAsBinaryString(file);
        } );
    
    $("#save-button").click( function() {
        var svg_to_save = $("#svg-file > svg");
        if( svg_to_save.length === 0 )
        {
            alert( "No SVG to save. This button should be disabled." );
            return;
        }
        
        // NOTE: svg_to_save[0].outerHTML does not seem to work with SVG.
        //       It is also less correct, because we lose the header comments
        //       that were in the file before the <svg> tag.
        var blob = new Blob([ svg_to_save.parent().html() ], {type: "image/svg+xml"});
        saveAs( blob, $('#filename').text() );
        } );
}

function loadSVG( svg_text )
{
    // Attach the SVG to its node.
    $('#svg-file').html( svg_text );
    // Get the actual SVG dom element with [0] rather than a jquery object.
    var svg = $('#svg-file > svg')[0];
    
    // Set the width and height of the SVG area.
    var svg_holder = $('#svg-holder');
    svg_holder.removeClass( "empty" );
    svg_holder.width( svg.getBBox().width );
    svg_holder.height( svg.getBBox().height );
    
    
    // TODO: Normalize SVG paths by replacing paths with data in normalizedPathSegList.
    normalizeSVG();
    
    // TODO: Setup UI
    createUIForSVG();
}

function normalizeSVG()
{
    // Iterate over all paths, replacing them with normalized versions of themselves.
    var svg = $('#svg-file path').each( function( index, path ) {
        
        path.pathSegList = path.normalizedPathSegList;
        return;
        
        /*
        var normalized = [];
        
        /// Adapted from: http://stackoverflow.com/questions/8053487/scripting-path-data-in-svg-reading-and-modifying
        // http://www.w3.org/TR/SVG/paths.html#__svg__SVGAnimatedPathData__normalizedPathSegList
        // See also path.pathSegList and path.animatedPathSegList and path.animatedNormalizedPathSegList
        var segments = path.normalizedPathSegList;
        for( var i = 0, len = segments.numberOfItems; i < len; ++i )
        {
            var pathSeg = segments.getItem(i);
            // http://www.w3.org/TR/SVG/paths.html#InterfaceSVGPathSeg
            switch(pathSeg.pathSegType) {
                case SVGPathSeg.PATHSEG_MOVETO_ABS:
                    // http://www.w3.org/TR/SVG/paths.html#InterfaceSVGPathSegMovetoAbs
                    console.log("Move to",pathSeg.x,pathSeg.y);
                break;
                
                case SVGPathSeg.PATHSEG_LINETO_ABS:
                    // http://www.w3.org/TR/SVG/paths.html#InterfaceSVGPathSegLinetoAbs
                    console.log("Line to",pathSeg.x,pathSeg.y);
                break;
                
                case SVGPathSeg.PATHSEG_CLOSEPATH:
                    // http://www.w3.org/TR/SVG/paths.html#InterfaceSVGPathSegClosePath
                    console.log("Close Path");
                break;
            }
        }
        */
        
        } );
}

function createUIForSVG()
{
    console.log( "createUIForSVG()" );
}

///
/// Initialization.
///
$(document).ready( function() {
    
    // TODO: Setup websocket
    setupWebsocket();
    
    setupFileIO();
});
</script>
</body>
</html>
